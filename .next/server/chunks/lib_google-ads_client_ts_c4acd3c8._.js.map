{"version":3,"sources":["turbopack:///[project]/lib/google-ads/client.ts"],"sourcesContent":["/**\r\n * Google Ads API Client\r\n * Documentation:\r\n * - Getting started: https://developers.google.com/google-ads/api/docs/get-started/make-first-call\r\n * - OAuth: https://developers.google.com/google-ads/api/docs/oauth/overview\r\n * - Common errors: https://developers.google.com/google-ads/api/docs/get-started/common-errors\r\n */\r\n\r\nimport logger, { PlatformAPIError, logAPISuccess, logTokenRefresh } from '../logging/logger'\r\nimport { withRateLimit } from '../rate-limiting/limiter'\r\n\r\nexport interface GoogleAdsConfig {\r\n  clientId: string\r\n  clientSecret: string\r\n  developerToken: string\r\n  customerId: string\r\n  refreshToken?: string\r\n  loginCustomerId?: string\r\n}\r\n\r\nexport async function getGoogleAdsAccessToken(\r\n  clientId: string,\r\n  clientSecret: string,\r\n  refreshToken: string\r\n): Promise<string> {\r\n  try {\r\n    const response = await fetch('https://oauth2.googleapis.com/token', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/x-www-form-urlencoded',\r\n      },\r\n      body: new URLSearchParams({\r\n        client_id: clientId,\r\n        client_secret: clientSecret,\r\n        refresh_token: refreshToken,\r\n        grant_type: 'refresh_token',\r\n      }),\r\n    })\r\n\r\n    const data = await response.json()\r\n\r\n    if (!response.ok) {\r\n      const errorMessage = data.error_description || data.error || 'Failed to refresh access token'\r\n      logTokenRefresh('google_ads', false, undefined, new Error(errorMessage))\r\n      throw new PlatformAPIError('google_ads', 'refreshToken', new Error(errorMessage), response.status, data.error)\r\n    }\r\n\r\n    if (!data.access_token) {\r\n      const error = new Error('No access token returned from Google OAuth refresh flow')\r\n      logTokenRefresh('google_ads', false, undefined, error)\r\n      throw error\r\n    }\r\n\r\n    logTokenRefresh('google_ads', true)\r\n    return data.access_token\r\n  } catch (error) {\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function fetchGoogleAdsCampaigns(config: GoogleAdsConfig) {\r\n  if (!config.refreshToken) {\r\n    throw new Error('Missing refresh token for Google Ads OAuth flow')\r\n  }\r\n\r\n  logger.info('Fetching Google Ads campaigns', { customerId: config.customerId })\r\n\r\n  // Google Ads API uses GAQL (Google Ads Query Language)\r\n  const query = `\r\n    SELECT\r\n      campaign.id,\r\n      campaign.name,\r\n      campaign.status,\r\n      campaign_budget.amount_micros,\r\n      metrics.impressions,\r\n      metrics.clicks,\r\n      metrics.conversions,\r\n      metrics.conversions_value,\r\n      metrics.cost_micros,\r\n      metrics.ctr,\r\n      metrics.average_cpc,\r\n      segments.date\r\n    FROM campaign\r\n    WHERE segments.date DURING LAST_30_DAYS\r\n    ORDER BY metrics.clicks DESC\r\n  `\r\n\r\n  const accessToken = await getGoogleAdsAccessToken(\r\n    config.clientId,\r\n    config.clientSecret,\r\n    config.refreshToken\r\n  )\r\n\r\n  const endpoint = `https://googleads.googleapis.com/v21/customers/${config.customerId}/googleAds:search`\r\n\r\n  const data = await withRateLimit('google_ads', async () => {\r\n    const response = await fetch(endpoint, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${accessToken}`,\r\n        'developer-token': config.developerToken,\r\n        ...(config.loginCustomerId ? { 'login-customer-id': config.loginCustomerId } : {}),\r\n      },\r\n      body: JSON.stringify({ query, pageSize: 1000 }),\r\n    })\r\n\r\n    const responseData = await response.json()\r\n\r\n    if (!response.ok) {\r\n      const error = responseData.error?.message || 'Unknown Google Ads API error'\r\n      throw new PlatformAPIError(\r\n        'google_ads',\r\n        'fetchCampaigns',\r\n        new Error(error),\r\n        response.status,\r\n        responseData.error?.code?.toString()\r\n      )\r\n    }\r\n\r\n    return responseData\r\n  })\r\n\r\n  const resultCount = Array.isArray(data?.results) ? data.results.length : 0\r\n  logAPISuccess('google_ads', 'fetchCampaigns', { resultCount })\r\n\r\n  return data\r\n}\r\n\r\nexport function transformGoogleAdsData(apiData: any) {\r\n  const campaigns: any[] = []\r\n  const metrics: any[] = []\r\n\r\n  const campaignMap = new Map<string, any>()\r\n\r\n  const rows = Array.isArray(apiData?.results) ? apiData.results : []\r\n\r\n  rows.forEach((row: any) => {\r\n    const campaign = row?.campaign\r\n    if (!campaign?.id) {\r\n      return\r\n    }\r\n\r\n    const campaignId = campaign.id.toString()\r\n\r\n    if (!campaignMap.has(campaignId)) {\r\n      const budgetMicros = row?.campaignBudget?.amountMicros\r\n\r\n      campaignMap.set(campaignId, {\r\n        campaign_id: campaignId,\r\n        campaign_name: campaign.name,\r\n        platform: 'google_ads',\r\n        status: normalizeGoogleStatus(campaign.status),\r\n        budget_amount: budgetMicros ? Number(budgetMicros) / 1_000_000 : null,\r\n      })\r\n    }\r\n\r\n    const campaignMetrics = row?.metrics ?? {}\r\n    const segments = row?.segments ?? {}\r\n\r\n    metrics.push({\r\n      campaign_api_id: campaignId,\r\n      date: segments.date || new Date().toISOString().split('T')[0],\r\n      impressions: campaignMetrics.impressions ? Number(campaignMetrics.impressions) : 0,\r\n      clicks: campaignMetrics.clicks ? Number(campaignMetrics.clicks) : 0,\r\n      conversions: campaignMetrics.conversions ? Number(campaignMetrics.conversions) : 0,\r\n      spend: campaignMetrics.costMicros ? Number(campaignMetrics.costMicros) / 1_000_000 : 0,\r\n      revenue: campaignMetrics.conversionsValue\r\n        ? Number(campaignMetrics.conversionsValue)\r\n        : 0,\r\n    })\r\n  })\r\n\r\n  campaigns.push(...campaignMap.values())\r\n\r\n  return { campaigns, metrics }\r\n}\r\n\r\nfunction normalizeGoogleStatus(status: string): string {\r\n  const statusMap: Record<string, string> = {\r\n    'ENABLED': 'active',\r\n    'PAUSED': 'paused',\r\n    'REMOVED': 'archived',\r\n  }\r\n  return statusMap[status] || status.toLowerCase()\r\n}\r\n\r\n"],"names":[],"mappings":"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"}