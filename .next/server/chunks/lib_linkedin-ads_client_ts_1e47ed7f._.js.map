{"version":3,"sources":["turbopack:///[project]/lib/linkedin-ads/client.ts"],"sourcesContent":["/**\r\n * LinkedIn Ads API Client\r\n * Documentation:\r\n * - Authentication: https://learn.microsoft.com/en-us/linkedin/shared/authentication/authentication\r\n * - Getting Access: https://learn.microsoft.com/en-us/linkedin/shared/authentication/getting-access\r\n * - Marketing API: https://learn.microsoft.com/en-us/linkedin/marketing/\r\n * - Best Practices: https://learn.microsoft.com/en-us/linkedin/shared/api-guide/best-practices/overview\r\n * \r\n * Note: Marketing API requires approval as an Advertising API partner.\r\n * Uses Rest.li Protocol 2.0.0 with LinkedIn-specific headers.\r\n */\r\n\r\nimport logger, { PlatformAPIError, logAPISuccess } from '../logging/logger'\r\nimport { withRateLimit } from '../rate-limiting/limiter'\r\n\r\nconst DEFAULT_API_VERSION = '202505'\r\nconst LINKEDIN_API_BASE = 'https://api.linkedin.com'\r\n\r\nexport interface LinkedInAdsConfig {\r\n  accessToken: string\r\n  apiVersion?: string\r\n}\r\n\r\n/**\r\n * Helper to create standard LinkedIn API headers following Rest.li protocol\r\n */\r\nfunction getLinkedInHeaders(accessToken: string, apiVersion: string): Record<string, string> {\r\n  return {\r\n    'Authorization': `Bearer ${accessToken}`,\r\n    'LinkedIn-Version': apiVersion,\r\n    'X-Restli-Protocol-Version': '2.0.0',\r\n    'Connection': 'Keep-Alive',\r\n  }\r\n}\r\n\r\n/**\r\n * Calculate date range for last 30 days in LinkedIn format\r\n */\r\nfunction getDateRange() {\r\n  const end = new Date()\r\n  const start = new Date()\r\n  start.setDate(start.getDate() - 30)\r\n\r\n  return {\r\n    start: {\r\n      year: start.getFullYear(),\r\n      month: start.getMonth() + 1,\r\n      day: start.getDate(),\r\n    },\r\n    end: {\r\n      year: end.getFullYear(),\r\n      month: end.getMonth() + 1,\r\n      day: end.getDate(),\r\n    },\r\n  }\r\n}\r\n\r\nexport async function fetchLinkedInAdsCampaigns(config: LinkedInAdsConfig) {\r\n  const apiVersion = config.apiVersion ?? DEFAULT_API_VERSION\r\n  const headers = getLinkedInHeaders(config.accessToken, apiVersion)\r\n\r\n  logger.info('Fetching LinkedIn Ads campaigns')\r\n\r\n  // Validate required configuration\r\n  if (!config.accessToken) {\r\n    throw new Error('LinkedIn Ads access token is required')\r\n  }\r\n\r\n  // Step 1: Fetch ad accounts using Rest.li finder method\r\n  const accountsUrl = `${LINKEDIN_API_BASE}/rest/adAccounts?q=search&search=(status:(values:List(ACTIVE,DRAFT)))`\r\n  \r\n  const accountsData = await withRateLimit('linkedin_ads', async () => {\r\n    try {\r\n      const accountsResponse = await fetch(accountsUrl, {\r\n        method: 'GET',\r\n        headers: {\r\n          ...headers,\r\n          'X-RestLi-Method': 'finder',\r\n        },\r\n      })\r\n\r\n      if (!accountsResponse.ok) {\r\n        const errorText = await accountsResponse.text()\r\n        let error: any = {}\r\n        try {\r\n          error = JSON.parse(errorText)\r\n        } catch {\r\n          error = { message: errorText || accountsResponse.statusText }\r\n        }\r\n\r\n        // Handle specific LinkedIn API errors\r\n        const errorMessage = error.message || error.error_description || accountsResponse.statusText\r\n\r\n        // Token expiration or invalid token\r\n        if (accountsResponse.status === 401 || accountsResponse.status === 403) {\r\n          throw new PlatformAPIError(\r\n            'linkedin_ads',\r\n            'fetchAdAccounts',\r\n            new Error('Access token expired or invalid. Please reconnect your LinkedIn Ads account.'),\r\n            accountsResponse.status,\r\n            error.code?.toString()\r\n          )\r\n        }\r\n\r\n        // Rate limit errors\r\n        if (accountsResponse.status === 429) {\r\n          const retryAfter = accountsResponse.headers.get('Retry-After')\r\n          throw new PlatformAPIError(\r\n            'linkedin_ads',\r\n            'fetchAdAccounts',\r\n            new Error(`Rate limit exceeded. Retry after ${retryAfter || 'some time'}`),\r\n            accountsResponse.status,\r\n            error.code?.toString()\r\n          )\r\n        }\r\n\r\n        throw new PlatformAPIError(\r\n          'linkedin_ads',\r\n          'fetchAdAccounts',\r\n          new Error(errorMessage),\r\n          accountsResponse.status,\r\n          error.code?.toString()\r\n        )\r\n      }\r\n\r\n      return await accountsResponse.json()\r\n    } catch (error: any) {\r\n      // Re-throw PlatformAPIError as-is\r\n      if (error instanceof PlatformAPIError) {\r\n        throw error\r\n      }\r\n      // Wrap other errors\r\n      throw new PlatformAPIError(\r\n        'linkedin_ads',\r\n        'fetchAdAccounts',\r\n        error,\r\n        undefined,\r\n        undefined\r\n      )\r\n    }\r\n  })\r\n  \r\n  if (!accountsData.elements || accountsData.elements.length === 0) {\r\n    throw new Error('No LinkedIn ad accounts found. Ensure the access token has the required Marketing API permissions.')\r\n  }\r\n\r\n  const adAccountId = accountsData.elements[0]?.id\r\n  if (!adAccountId) {\r\n    throw new Error('Invalid LinkedIn ad account ID in response')\r\n  }\r\n\r\n  // Step 2: Fetch campaigns for the ad account\r\n  // Build URN properly - account ID should be numeric\r\n  const accountUrn = adAccountId.toString().startsWith('urn:li:sponsoredAccount:') \r\n    ? adAccountId.toString() \r\n    : `urn:li:sponsoredAccount:${adAccountId}`\r\n  \r\n  const campaignsUrl = `${LINKEDIN_API_BASE}/rest/adCampaigns?q=search&search=(account:(values:List(${accountUrn})))&count=100`\r\n  \r\n  const campaignsData = await withRateLimit('linkedin_ads', async () => {\r\n    try {\r\n      const campaignsResponse = await fetch(campaignsUrl, {\r\n        method: 'GET',\r\n        headers: {\r\n          ...headers,\r\n          'X-RestLi-Method': 'finder',\r\n        },\r\n      })\r\n\r\n      if (!campaignsResponse.ok) {\r\n        const errorText = await campaignsResponse.text()\r\n        let error: any = {}\r\n        try {\r\n          error = JSON.parse(errorText)\r\n        } catch {\r\n          error = { message: errorText || campaignsResponse.statusText }\r\n        }\r\n\r\n        const errorMessage = error.message || error.error_description || campaignsResponse.statusText\r\n\r\n        // Token expiration or invalid token\r\n        if (campaignsResponse.status === 401 || campaignsResponse.status === 403) {\r\n          throw new PlatformAPIError(\r\n            'linkedin_ads',\r\n            'fetchCampaigns',\r\n            new Error('Access token expired or invalid. Please reconnect your LinkedIn Ads account.'),\r\n            campaignsResponse.status,\r\n            error.code?.toString()\r\n          )\r\n        }\r\n\r\n        // Rate limit errors\r\n        if (campaignsResponse.status === 429) {\r\n          const retryAfter = campaignsResponse.headers.get('Retry-After')\r\n          throw new PlatformAPIError(\r\n            'linkedin_ads',\r\n            'fetchCampaigns',\r\n            new Error(`Rate limit exceeded. Retry after ${retryAfter || 'some time'}`),\r\n            campaignsResponse.status,\r\n            error.code?.toString()\r\n          )\r\n        }\r\n\r\n        throw new PlatformAPIError(\r\n          'linkedin_ads',\r\n          'fetchCampaigns',\r\n          new Error(errorMessage),\r\n          campaignsResponse.status,\r\n          error.code?.toString()\r\n        )\r\n      }\r\n\r\n      return await campaignsResponse.json()\r\n    } catch (error: any) {\r\n      // Re-throw PlatformAPIError as-is\r\n      if (error instanceof PlatformAPIError) {\r\n        throw error\r\n      }\r\n      // Wrap other errors\r\n      throw new PlatformAPIError(\r\n        'linkedin_ads',\r\n        'fetchCampaigns',\r\n        error,\r\n        undefined,\r\n        undefined\r\n      )\r\n    }\r\n  })\r\n\r\n  if (!campaignsData.elements || campaignsData.elements.length === 0) {\r\n    logger.info('No LinkedIn campaigns found')\r\n    return []\r\n  }\r\n\r\n  // Step 3: Fetch analytics for campaigns (batch request for efficiency)\r\n  const dateRange = getDateRange()\r\n  const campaignIds = campaignsData.elements.map((c: any) => c.id)\r\n\r\n  const analyticsParams = new URLSearchParams({\r\n    q: 'analytics',\r\n    pivot: 'CAMPAIGN',\r\n    dateRange: JSON.stringify(dateRange),\r\n    campaigns: `List(${campaignIds.join(',')})`,\r\n    fields: 'impressions,clicks,costInLocalCurrency,externalWebsiteConversions,conversionValueInLocalCurrency',\r\n  })\r\n\r\n  const analyticsUrl = `${LINKEDIN_API_BASE}/rest/adAnalytics?${analyticsParams.toString()}`\r\n  \r\n  const analyticsData = await withRateLimit('linkedin_ads', async () => {\r\n    try {\r\n      const analyticsResponse = await fetch(analyticsUrl, {\r\n        method: 'GET',\r\n        headers: {\r\n          ...headers,\r\n          'X-RestLi-Method': 'finder',\r\n        },\r\n      })\r\n\r\n      if (analyticsResponse.ok) {\r\n        return await analyticsResponse.json()\r\n      }\r\n      \r\n      // Log warning but don't fail the entire request if analytics fails\r\n      const errorText = await analyticsResponse.text()\r\n      logger.warn('LinkedIn analytics fetch failed, continuing without analytics', {\r\n        status: analyticsResponse.status,\r\n        error: errorText,\r\n      })\r\n      return { elements: [] }\r\n    } catch (error: any) {\r\n      // Don't fail the entire request if analytics fails\r\n      logger.warn('LinkedIn analytics fetch error, continuing without analytics', { error })\r\n      return { elements: [] }\r\n    }\r\n  })\r\n\r\n  // Map analytics to campaigns\r\n  const analyticsMap = new Map(\r\n    analyticsData.elements?.map((a: any) => [a.pivotValues?.[0], a]) || []\r\n  )\r\n\r\n  const campaignsWithMetrics = campaignsData.elements.map((campaign: any) => ({\r\n    ...campaign,\r\n    analytics: analyticsMap.get(campaign.id) || null,\r\n  }))\r\n\r\n  logAPISuccess('linkedin_ads', 'fetchCampaigns', {\r\n    campaignCount: campaignsWithMetrics.length,\r\n    withAnalytics: campaignsWithMetrics.filter((c: any) => c.analytics).length,\r\n  })\r\n\r\n  return campaignsWithMetrics\r\n}\r\n\r\nexport function transformLinkedInAdsData(apiData: any[]) {\r\n  const campaigns: any[] = []\r\n  const metrics: any[] = []\r\n\r\n  apiData.forEach((campaign: any) => {\r\n    campaigns.push({\r\n      campaign_id: campaign.id.toString(),\r\n      campaign_name: campaign.name,\r\n      platform: 'linkedin_ads',\r\n      status: normalizeLinkedInStatus(campaign.status),\r\n      budget_amount: campaign.dailyBudget?.amount\r\n        ? parseFloat(campaign.dailyBudget.amount)\r\n        : null,\r\n    })\r\n\r\n    if (campaign.analytics) {\r\n      metrics.push({\r\n        campaign_api_id: campaign.id.toString(),\r\n        date: new Date().toISOString().split('T')[0],\r\n        impressions: parseInt(campaign.analytics.impressions) || 0,\r\n        clicks: parseInt(campaign.analytics.clicks) || 0,\r\n        conversions: parseFloat(campaign.analytics.externalWebsiteConversions) || 0,\r\n        spend: parseFloat(campaign.analytics.costInLocalCurrency) || 0,\r\n        revenue: parseFloat(campaign.analytics.conversionValueInLocalCurrency) || 0,\r\n      })\r\n    }\r\n  })\r\n\r\n  return { campaigns, metrics }\r\n}\r\n\r\nfunction normalizeLinkedInStatus(status: string): string {\r\n  const statusMap: Record<string, string> = {\r\n    'ACTIVE': 'active',\r\n    'PAUSED': 'paused',\r\n    'ARCHIVED': 'archived',\r\n    'DRAFT': 'paused',\r\n  }\r\n  return statusMap[status] || status.toLowerCase()\r\n}\r\n\r\n"],"names":[],"mappings":"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"}