module.exports=[13694,e=>{"use strict";var t=e.i(54799);function a(e,a){if(!e||!a)throw Error("Access token and app secret are required to generate app secret proof");return t.default.createHmac("sha256",a).update(e).digest("hex")}var s=e.i(100),i=e.i(52787);async function r(t){let a=[],i=t;for(;i;)try{let t=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json"}});if((await e.A(45343)).default().checkMetaRateLimit(Object.fromEntries(t.headers.entries())),!t.ok){let e=await t.text(),a={};try{a=JSON.parse(e)}catch{a={error:{message:e||t.statusText}}}let i=a.error?.code,r=a.error?.message||t.statusText;if(190===i||401===t.status)throw new s.PlatformAPIError("meta_ads","fetchAllPages",Error("Access token expired or invalid. Please reconnect your Meta Ads account."),t.status,i?.toString());if([4,17,32,613].includes(i))throw new s.PlatformAPIError("meta_ads","fetchAllPages",Error(`Rate limit exceeded: ${r}`),t.status,i?.toString());throw new s.PlatformAPIError("meta_ads","fetchAllPages",Error(r),t.status,i?.toString())}let r=await t.json();Array.isArray(r.data)&&a.push(...r.data),i=r.paging?.next}catch(e){if(e instanceof s.PlatformAPIError)throw e;throw new s.PlatformAPIError("meta_ads","fetchAllPages",e,void 0,void 0)}return a}async function n(e){let t=e.apiVersion??"v21.0",n=e.accountId;n.startsWith("act_")||(n=n.replace(/^act_/,""),n=`act_${n}`);let c=new Date(Date.now()-2592e6).toISOString().split("T")[0],o=new Date().toISOString().split("T")[0];if(s.default.info("Fetching Meta Ads campaigns",{accountId:n,dateRange:{since:c,until:o}}),!e.accessToken)throw Error("Meta Ads access token is required");if(!n)throw Error("Meta Ads account ID is required");let p=new URLSearchParams({fields:"id,name,status,daily_budget,objective",access_token:e.accessToken,limit:"100"});if(e.appSecret){let t=a(e.accessToken,e.appSecret);p.set("appsecret_proof",t)}let d=`https://graph.facebook.com/${t}/${n}/campaigns?${p.toString()}`,l=await (0,i.withRateLimit)("meta_ads",async()=>await r(d)),m=new URLSearchParams({fields:"campaign_id,campaign_name,campaign_status,objective,impressions,clicks,spend,actions,action_values,date_start,date_stop",level:"campaign",time_range:JSON.stringify({since:c,until:o}),action_attribution_windows:JSON.stringify(["1d_click","7d_click"]),use_unified_attribution_setting:"true",access_token:e.accessToken,limit:"100"});if(e.appSecret){let t=a(e.accessToken,e.appSecret);m.set("appsecret_proof",t)}let u=`https://graph.facebook.com/${t}/${n}/insights?${m.toString()}`,g=await (0,i.withRateLimit)("meta_ads",async()=>await r(u));return(0,s.logAPISuccess)("meta_ads","fetchCampaigns",{campaignCount:l.length,insightsCount:g.length}),{campaignMetadata:l,insightsData:g,dateRange:{since:c,until:o}}}function c(e){let t=[],a=[],s=new Map(e.campaignMetadata.map(e=>[e.id,e])),i=new Set;return e.insightsData.forEach(r=>{if(!i.has(r.campaign_id)){var n;let e=s.get(r.campaign_id);t.push({campaign_id:r.campaign_id,campaign_name:r.campaign_name,platform:"meta_ads",status:{ACTIVE:"active",PAUSED:"paused",DELETED:"archived",ARCHIVED:"archived"}[n=r.campaign_status||e?.status||"UNKNOWN"]||n.toLowerCase(),budget_amount:e?.daily_budget?parseFloat(e.daily_budget)/100:null,objective:r.objective||e?.objective||null}),i.add(r.campaign_id)}let c=r.actions?.find(e=>"offsite_conversion.fb_pixel_purchase"===e.action_type||"purchase"===e.action_type),o=r.action_values?.find(e=>"offsite_conversion.fb_pixel_purchase"===e.action_type||"purchase"===e.action_type);a.push({campaign_api_id:r.campaign_id,date:r.date_stop||e.dateRange.until,impressions:r.impressions?parseInt(r.impressions,10):0,clicks:r.clicks?parseInt(r.clicks,10):0,conversions:c?parseFloat(c.value):0,spend:r.spend?parseFloat(r.spend):0,revenue:o?parseFloat(o.value):0})}),{campaigns:t,metrics:a}}e.s(["fetchMetaAdsCampaigns",()=>n,"transformMetaAdsData",()=>c],13694)},45343,e=>{e.v(e=>Promise.resolve().then(()=>e(52787)))}];

//# sourceMappingURL=lib_e9c55510._.js.map