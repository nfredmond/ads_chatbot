module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},88947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},16529,e=>{"use strict";var t=e.i(87464);function r(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("SUPABASE_SERVICE_ROLE_KEY environment variable is not set. Please add it to your .env.local file.");return(0,t.createClient)("https://pfatayebacwjehlfxipx.supabase.co",e,{auth:{persistSession:!1}})}e.s(["createServiceRoleClient",()=>r])},79594,(e,t,r)=>{t.exports=e.x("dns",()=>require("dns"))},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},95486,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),s=e.i(59756),n=e.i(61916),i=e.i(14444),o=e.i(37092),l=e.i(69741),c=e.i(16795),p=e.i(87718),d=e.i(95169),u=e.i(47587),m=e.i(66012),g=e.i(70101),f=e.i(26937),v=e.i(10372),h=e.i(93695);e.i(52474);var x=e.i(5232),R=e.i(89171),E=e.i(89660),w=e.i(100),y=e.i(56111),C=e.i(16529);class _{async fetchAllPlatformMetrics(e,t){w.default.info("Fetching cross-platform metrics",{userId:e,dateRange:t});try{let r=(0,C.createServiceRoleClient)(),{data:a,error:s}=await r.from("profiles").select("tenant_id").eq("id",e).single();if(s)return w.default.error("Failed to resolve tenant for user",{userId:e,error:s}),[];if(!a?.tenant_id)return w.default.warn("No tenant associated with user, skipping metrics fetch",{userId:e}),[];let n=a.tenant_id,i=(0,y.generateCacheKey)("aggregated","metrics",n,t.start,t.end),o=await (0,y.getCached)(i);if(o)return w.default.info("Returning cached cross-platform metrics"),o;let l=await this.loadTenantMetrics(r,n,t);return await (0,y.setCached)(i,l,y.CACHE_TTL.METRICS),w.default.info("Cross-platform metrics fetched successfully",{tenantId:n,campaignCount:l.length}),l}catch(e){return w.default.error("Failed to fetch cross-platform metrics",{error:e}),[]}}async loadTenantMetrics(e,t,r){let{data:a,error:s}=await e.from("campaigns").select("id,campaign_id,campaign_name,platform,status").eq("tenant_id",t);if(s)return w.default.error("Failed to fetch campaigns for tenant",{tenantId:t,error:s}),[];let{data:n,error:i}=await e.from("campaign_metrics").select("campaign_id,impressions,clicks,spend,conversions,revenue,date").eq("tenant_id",t).gte("date",r.start).lte("date",r.end);if(i)return w.default.error("Failed to fetch campaign metrics",{tenantId:t,error:i}),[];let o=new Map;for(let e of n||[]){if(!e?.campaign_id)continue;o.has(e.campaign_id)||o.set(e.campaign_id,{impressions:0,clicks:0,spend:0,conversions:0,revenue:0});let t=o.get(e.campaign_id);t.impressions+=Number(e.impressions||0),t.clicks+=Number(e.clicks||0),t.spend+=Number(e.spend||0),t.conversions+=Number(e.conversions||0),t.revenue+=Number(e.revenue||0)}let l=[];for(let e of a||[]){if(!["google_ads","meta_ads","linkedin_ads"].includes(e.platform))continue;let t=o.get(e.id)||{impressions:0,clicks:0,spend:0,conversions:0,revenue:0},r={platform:e.platform,campaignId:e.campaign_id,campaignName:e.campaign_name,status:this.normalizeStatus(e.platform,e.status),impressions:t.impressions,clicks:t.clicks,spend:t.spend,conversions:t.conversions,revenue:t.revenue,ctr:0,cpc:0,cpm:0,roas:0,conversionRate:0,costPerConversion:0};this.applyDerivedMetrics(r),l.push(r)}return l}normalizeStatus(e,t){let r=String(t||"").toUpperCase();return({google_ads:{ENABLED:"active",PAUSED:"paused",REMOVED:"archived"},meta_ads:{ACTIVE:"active",PAUSED:"paused",DELETED:"archived",ARCHIVED:"archived"},linkedin_ads:{ACTIVE:"active",PAUSED:"paused",ARCHIVED:"archived",DRAFT:"paused"}})[e]?.[r]||"unknown"}applyDerivedMetrics(e){e.ctr=e.impressions>0?e.clicks/e.impressions*100:0,e.cpc=e.clicks>0?e.spend/e.clicks:0,e.cpm=e.impressions>0?e.spend/e.impressions*1e3:0,e.roas=e.spend>0?e.revenue/e.spend:0,e.conversionRate=e.clicks>0?e.conversions/e.clicks*100:0,e.costPerConversion=e.conversions>0?e.spend/e.conversions:0}aggregateByPlatform(e){let t={};return e.forEach(e=>{t[e.platform]||(t[e.platform]={platform:e.platform,campaignId:"aggregated",campaignName:`${e.platform} Total`,status:"active",impressions:0,clicks:0,spend:0,conversions:0,revenue:0,ctr:0,cpc:0,cpm:0,roas:0,conversionRate:0,costPerConversion:0});let r=t[e.platform];r.impressions+=e.impressions,r.clicks+=e.clicks,r.spend+=e.spend,r.conversions+=e.conversions,r.revenue+=e.revenue}),Object.values(t).forEach(e=>this.applyDerivedMetrics(e)),t}getTotalMetrics(e){let t={platform:"all",campaignId:"total",campaignName:"Total (All Platforms)",status:"active",impressions:0,clicks:0,spend:0,conversions:0,revenue:0,ctr:0,cpc:0,cpm:0,roas:0,conversionRate:0,costPerConversion:0};return e.forEach(e=>{t.impressions+=e.impressions,t.clicks+=e.clicks,t.spend+=e.spend,t.conversions+=e.conversions,t.revenue+=e.revenue}),this.applyDerivedMetrics(t),t}}let A=null;async function k(e){try{let t=await (0,E.createClient)(),{data:{user:r}}=await t.auth.getUser();if(!r)return R.NextResponse.json({error:"Unauthorized"},{status:401});let a=e.nextUrl.searchParams,s=a.get("startDate")||new Date(Date.now()-2592e6).toISOString().split("T")[0],n=a.get("endDate")||new Date().toISOString().split("T")[0],i=a.get("aggregateBy");w.default.info("Fetching aggregated analytics",{userId:r.id,startDate:s,endDate:n,aggregateBy:i});let o=(A||(A=new _),A),l=await o.fetchAllPlatformMetrics(r.id,{start:s,end:n});if("platform"===i){let e=o.aggregateByPlatform(l);return R.NextResponse.json({aggregated:Object.values(e)})}if("total"===i){let e=o.getTotalMetrics(l);return R.NextResponse.json({total:e})}return R.NextResponse.json({campaigns:l})}catch(e){return w.default.error("Analytics aggregation error",{error:e}),R.NextResponse.json({error:"Failed to fetch analytics",details:e.message},{status:500})}}e.s(["GET",()=>k],87961);var P=e.i(87961);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/analytics/aggregated/route",pathname:"/api/analytics/aggregated",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/analytics/aggregated/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:T,workUnitAsyncStorage:b,serverHooks:N}=S;function q(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:b})}async function D(e,t,a){S.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/analytics/aggregated/route";R=R.replace(/\/index$/,"")||"/";let E=await S.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:y,nextConfig:C,parsedUrl:_,isDraftMode:A,prerenderManifest:k,routerServerContext:P,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,resolvedPathname:N,clientReferenceManifest:q,serverActionsManifest:D}=E,M=(0,l.normalizeAppPath)(R),I=!!(k.dynamicRoutes[M]||k.routes[N]),O=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,_,!1):t.end("This page could not be found"),null);if(I&&!A){let e=!!k.routes[N],t=k.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await O();throw new h.NoFallbackError}}let j=null;!I||S.isDev||A||(j="/index"===(j=N)?"/":j);let U=!0===S.isDev||!I,H=I&&!U;D&&q&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:q,serverActionsManifest:D,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:D})});let F=e.method||"GET",B=(0,n.getTracer)(),K=B.getActiveScopeSpan(),L={params:y,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>S.onRequestError(e,t,a,P)},sharedContext:{buildId:w}},V=new c.NodeNextRequest(e),$=new c.NodeNextResponse(t),z=p.NextRequestAdapter.fromNodeNextRequest(V,(0,p.signalFromNodeResponse)(t));try{let i=async e=>S.handle(z,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${R}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&T&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=L.renderOpts.collectedTags;if(!I)return await (0,m.sendResponse)(V,$,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[v.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},P),t}},p=await S.handleResponse({req:e,nextConfig:C,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!I)return null;if((null==p||null==(n=p.value)?void 0:n.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",T?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(p.value.headers);return o&&I||d.delete(v.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(V,$,new Response(p.value.body,{headers:d,status:p.value.status||200})),null};K?await l(K):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),I)throw t;return await (0,m.sendResponse)(V,$,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>q,"routeModule",()=>S,"serverHooks",()=>N,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>b],95486)},36145,e=>{e.v(e=>Promise.resolve().then(()=>e(2808)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__664f218c._.js.map