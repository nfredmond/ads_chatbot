{"version":3,"sources":["turbopack:///[project]/lib/supabase/service-role.ts","turbopack:///[project]/lib/security/ad-account-tokens.ts","turbopack:///[project]/lib/security/encryption.ts"],"sourcesContent":["import { createClient, SupabaseClient } from '@supabase/supabase-js'\n\n/**\n * Creates a Supabase client with service role privileges.\n * This client bypasses Row Level Security and should only be used\n * for server-side operations that need elevated permissions.\n * \n * @throws Error if environment variables are not set at runtime\n */\nexport function createServiceRoleClient(): SupabaseClient {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!supabaseUrl) {\n    throw new Error(\n      'NEXT_PUBLIC_SUPABASE_URL environment variable is not set. ' +\n      'Please add it to your .env.local file.'\n    )\n  }\n\n  if (!supabaseServiceRoleKey) {\n    throw new Error(\n      'SUPABASE_SERVICE_ROLE_KEY environment variable is not set. ' +\n      'Please add it to your .env.local file.'\n    )\n  }\n\n  return createClient(supabaseUrl, supabaseServiceRoleKey, {\n    auth: {\n      persistSession: false,\n    },\n  })\n}\n","import logger from '../logging/logger'\r\nimport { encryptToken, decryptToken } from './encryption'\r\nimport { createServiceRoleClient } from '../supabase/service-role'\r\n\r\ninterface TokenUpdateInput {\r\n  accessToken?: string | null\r\n  refreshToken?: string | null\r\n}\r\n\r\ninterface DecryptedTokens {\r\n  accessToken: string | null\r\n  refreshToken: string | null\r\n}\r\n\r\nfunction buildEncryptedFields(token?: string | null) {\r\n  if (!token) {\r\n    return null\r\n  }\r\n\r\n  const encrypted = encryptToken(token)\r\n\r\n  return {\r\n    encrypted: encrypted.encrypted,\r\n    iv: encrypted.iv,\r\n    authTag: encrypted.authTag,\r\n  }\r\n}\r\n\r\nexport function buildEncryptedTokenUpdate(tokens: TokenUpdateInput) {\r\n  const update: Record<string, any> = {}\r\n\r\n  const access = buildEncryptedFields(tokens.accessToken)\r\n  if (access) {\r\n    update.access_token_encrypted = access.encrypted\r\n    update.access_token_iv = access.iv\r\n    update.access_token_auth_tag = access.authTag\r\n    update.access_token = null\r\n  }\r\n\r\n  const refresh = buildEncryptedFields(tokens.refreshToken)\r\n  if (refresh) {\r\n    update.refresh_token_encrypted = refresh.encrypted\r\n    update.refresh_token_iv = refresh.iv\r\n    update.refresh_token_auth_tag = refresh.authTag\r\n    update.refresh_token = null\r\n  }\r\n\r\n  return update\r\n}\r\n\r\nexport function decryptAccountTokens(account: any): DecryptedTokens {\r\n  let accessToken: string | null = null\r\n  let refreshToken: string | null = null\r\n\r\n  if (\r\n    account?.access_token_encrypted &&\r\n    account?.access_token_iv &&\r\n    account?.access_token_auth_tag\r\n  ) {\r\n    try {\r\n      accessToken = decryptToken({\r\n        encrypted: account.access_token_encrypted,\r\n        iv: account.access_token_iv,\r\n        authTag: account.access_token_auth_tag,\r\n      })\r\n    } catch (error) {\r\n      logger.error('Failed to decrypt access token', {\r\n        accountId: account?.id,\r\n        platform: account?.platform,\r\n        error,\r\n      })\r\n    }\r\n  } else if (account?.access_token) {\r\n    accessToken = account.access_token\r\n  }\r\n\r\n  if (\r\n    account?.refresh_token_encrypted &&\r\n    account?.refresh_token_iv &&\r\n    account?.refresh_token_auth_tag\r\n  ) {\r\n    try {\r\n      refreshToken = decryptToken({\r\n        encrypted: account.refresh_token_encrypted,\r\n        iv: account.refresh_token_iv,\r\n        authTag: account.refresh_token_auth_tag,\r\n      })\r\n    } catch (error) {\r\n      logger.error('Failed to decrypt refresh token', {\r\n        accountId: account?.id,\r\n        platform: account?.platform,\r\n        error,\r\n      })\r\n    }\r\n  } else if (account?.refresh_token) {\r\n    refreshToken = account.refresh_token\r\n  }\r\n\r\n  return { accessToken, refreshToken }\r\n}\r\n\r\nexport async function migratePlaintextTokens() {\r\n  try {\r\n    const supabase = createServiceRoleClient()\r\n\r\n    const { data: accounts, error } = await supabase\r\n      .from('ad_accounts')\r\n      .select(\r\n        'id, platform, access_token, refresh_token, access_token_encrypted, refresh_token_encrypted'\r\n      )\r\n      .or('access_token.not.is.null,refresh_token.not.is.null')\r\n\r\n    if (error) {\r\n      logger.error('Failed to query ad accounts for token migration', { error })\r\n      return\r\n    }\r\n\r\n    if (!accounts || accounts.length === 0) {\r\n      logger.info('No plaintext tokens found to migrate')\r\n      return\r\n    }\r\n\r\n    logger.info('Migrating plaintext ad account tokens', {\r\n      accounts: accounts.length,\r\n    })\r\n\r\n    for (const account of accounts) {\r\n      const update = buildEncryptedTokenUpdate({\r\n        accessToken: account.access_token,\r\n        refreshToken: account.refresh_token,\r\n      })\r\n\r\n      if (Object.keys(update).length === 0) {\r\n        continue\r\n      }\r\n\r\n      update.updated_at = new Date().toISOString()\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('ad_accounts')\r\n        .update(update)\r\n        .eq('id', account.id)\r\n\r\n      if (updateError) {\r\n        logger.error('Failed to migrate tokens for ad account', {\r\n          accountId: account.id,\r\n          platform: account.platform,\r\n          error: updateError,\r\n        })\r\n      }\r\n    }\r\n\r\n    logger.info('Plaintext token migration completed')\r\n  } catch (error) {\r\n    logger.error('Token migration failed', { error })\r\n  }\r\n}\r\n","/**\r\n * Token Encryption Utilities\r\n * Uses AES-256-GCM for secure token storage\r\n */\r\n\r\nimport crypto from 'crypto'\r\n\r\nconst ALGORITHM = 'aes-256-gcm'\r\nconst IV_LENGTH = 16\r\nconst AUTH_TAG_LENGTH = 16\r\n\r\ninterface EncryptedData {\r\n  encrypted: string\r\n  iv: string\r\n  authTag: string\r\n}\r\n\r\n/**\r\n * Get encryption key from environment variable\r\n * In production, this should be stored in a secure key management service\r\n */\r\nfunction getEncryptionKey(): Buffer {\r\n  const key = process.env.ENCRYPTION_KEY\r\n  \r\n  if (!key) {\r\n    throw new Error(\r\n      'ENCRYPTION_KEY environment variable is not set. ' +\r\n      'Generate one using: openssl rand -hex 32'\r\n    )\r\n  }\r\n  \r\n  // Ensure key is 32 bytes (64 hex characters)\r\n  if (key.length !== 64) {\r\n    throw new Error('ENCRYPTION_KEY must be 64 hex characters (32 bytes)')\r\n  }\r\n  \r\n  return Buffer.from(key, 'hex')\r\n}\r\n\r\n/**\r\n * Encrypt sensitive data (tokens, secrets) before storing in database\r\n */\r\nexport function encryptToken(plaintext: string): EncryptedData {\r\n  try {\r\n    const key = getEncryptionKey()\r\n    const iv = crypto.randomBytes(IV_LENGTH)\r\n    \r\n    const cipher = crypto.createCipheriv(ALGORITHM, key, iv)\r\n    \r\n    let encrypted = cipher.update(plaintext, 'utf8', 'hex')\r\n    encrypted += cipher.final('hex')\r\n    \r\n    const authTag = cipher.getAuthTag()\r\n    \r\n    return {\r\n      encrypted: encrypted,\r\n      iv: iv.toString('hex'),\r\n      authTag: authTag.toString('hex'),\r\n    }\r\n  } catch (error) {\r\n    throw new Error(`Token encryption failed: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n  }\r\n}\r\n\r\n/**\r\n * Decrypt sensitive data when retrieving from database\r\n */\r\nexport function decryptToken(encryptedData: EncryptedData): string {\r\n  try {\r\n    const key = getEncryptionKey()\r\n    \r\n    const decipher = crypto.createDecipheriv(\r\n      ALGORITHM,\r\n      key,\r\n      Buffer.from(encryptedData.iv, 'hex')\r\n    )\r\n    \r\n    decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'))\r\n    \r\n    let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8')\r\n    decrypted += decipher.final('utf8')\r\n    \r\n    return decrypted\r\n  } catch (error) {\r\n    throw new Error(`Token decryption failed: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n  }\r\n}\r\n\r\n/**\r\n * Generate a secure encryption key\r\n * Run this once and store the result in ENCRYPTION_KEY env variable\r\n */\r\nexport function generateEncryptionKey(): string {\r\n  return crypto.randomBytes(32).toString('hex')\r\n}\r\n\r\n/**\r\n * Encrypt multiple fields in an object\r\n */\r\nexport function encryptFields<T extends Record<string, any>>(\r\n  data: T,\r\n  fieldsToEncrypt: (keyof T)[]\r\n): Record<string, any> {\r\n  const encrypted: Record<string, any> = { ...data }\r\n  \r\n  for (const field of fieldsToEncrypt) {\r\n    const fieldStr = String(field)\r\n    const value = data[field]\r\n    if (value && typeof value === 'string') {\r\n      const encryptedData = encryptToken(value)\r\n      encrypted[`${fieldStr}_encrypted`] = encryptedData.encrypted\r\n      encrypted[`${fieldStr}_iv`] = encryptedData.iv\r\n      encrypted[`${fieldStr}_auth_tag`] = encryptedData.authTag\r\n      delete encrypted[fieldStr]\r\n    }\r\n  }\r\n  \r\n  return encrypted\r\n}\r\n\r\n/**\r\n * Decrypt multiple fields in an object\r\n */\r\nexport function decryptFields<T extends Record<string, any>>(\r\n  data: T,\r\n  fieldsToDecrypt: string[]\r\n): Record<string, any> {\r\n  const decrypted: Record<string, any> = { ...data }\r\n  \r\n  for (const field of fieldsToDecrypt) {\r\n    const encryptedField = `${field}_encrypted`\r\n    const ivField = `${field}_iv`\r\n    const authTagField = `${field}_auth_tag`\r\n    \r\n    if (data[encryptedField] && data[ivField] && data[authTagField]) {\r\n      try {\r\n        const encryptedData: EncryptedData = {\r\n          encrypted: data[encryptedField] as string,\r\n          iv: data[ivField] as string,\r\n          authTag: data[authTagField] as string,\r\n        }\r\n        \r\n        decrypted[field] = decryptToken(encryptedData)\r\n        delete decrypted[encryptedField]\r\n        delete decrypted[ivField]\r\n        delete decrypted[authTagField]\r\n      } catch (error) {\r\n        console.error(`Failed to decrypt field ${field}:`, error)\r\n        // Keep encrypted fields if decryption fails\r\n      }\r\n    }\r\n  }\r\n  \r\n  return decrypted\r\n}\r\n\r\n/**\r\n * Utility to test encryption/decryption\r\n */\r\nexport function testEncryption(): boolean {\r\n  try {\r\n    const testData = 'test-token-12345'\r\n    const encrypted = encryptToken(testData)\r\n    const decrypted = decryptToken(encrypted)\r\n    \r\n    return decrypted === testData\r\n  } catch (error) {\r\n    console.error('Encryption test failed:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}